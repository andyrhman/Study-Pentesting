########### https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-validation-depends-on-request-method
Open Burp's browser and log in to your account. Submit the "Update email" form, 
and find the resulting request in your Proxy history.

Send the request to Burp Repeater and observe that if you change the value of the csrf parameter 
then the request is rejected.

Use "Change request method" on the context menu to convert it into a GET request and observe that 
the CSRF token is no longer verified. 

########### https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-validation-depends-on-token-being-present

Open Burp's browser and log in to your account. Submit the "Update email" form, 
and find the resulting request in your Proxy history.

Send the request to Burp Repeater and observe that if you change the value 
of the csrf parameter then the request is rejected.

Delete the csrf parameter entirely and observe that the request is now accepted. 

########### https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-not-tied-to-user-session

Make 2 Accounts, use your first account for csrf token it is important that you don't use it.

Use your another account for testing the csrf token vulnerabilitiy.

Observe that if you swap the CSRF token with the value from the other account, then the request is accepted. 

########### https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-tied-to-non-session-cookie

Make 2 Accounts, use your first account for csrf token it is important that you don't use it.

Use your another account for testing the csrf token vulnerabilitiy.

Send the request to Burp Repeater and observe that changing the session cookie logs you out, 
but changing the csrfKey cookie merely results in the CSRF token being rejected. This suggests that the csrfKey cookie may not be strictly tied to the session.

Open a private/incognito browser window, log in to your other account, and send a fresh update email request into Burp Repeater.

Observe that if you swap the csrfKey cookie and csrf parameter from the first account to the second account, the request is accepted. 

Remove the auto-submit <script> block, and instead add the following code to inject the cookie:
<img src="https://YOUR-LAB-ID.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrfKey=YOUR-KEY%3b%20SameSite=None" onerror="document.forms[0].submit()">

Store the exploit, then click "Deliver to victim" to solve the lab. 

########### https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-duplicated-in-cookie

Open Burp's browser and log in to your account. Submit the "Update email" form, 
and find the resulting request in your Proxy history.

Send the request to Burp Repeater and observe that the value of the csrf body parameter 
is simply being validated by comparing it with the csrf cookie.

Perform a search, send the resulting request to Burp Repeater, and observe that the search term gets reflected 
in the Set-Cookie header. Since the search function has no CSRF protection, you can use this to inject cookies into the victim user's browser. 

########### https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses/lab-referer-validation-depends-on-header-being-present

Open Burp's browser and log in to your account. Submit the "Update email" form, and find the resulting request in your Proxy history.

Send the request to Burp Repeater and observe that if you change the domain in the Referer HTTP header then the request is rejected.

Delete the Referer header entirely and observe that the request is now accepted.

Create and host a proof of concept exploit as described in the solution to the CSRF vulnerability with no defenses lab. Include the following HTML to suppress the Referer header:
<meta name="referrer" content="no-referrer">

Store the exploit, then click "Deliver to victim" to solve the lab.

########### https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses/lab-referer-validation-broken

Open Burp's browser and log in to your account. Submit the "Update email" form, and find the resulting request in your Proxy history.

Send the request to Burp Repeater. Observe that if you change the domain in the Referer HTTP header, the request is rejected.

Copy the original domain of your lab instance and append it to the Referer header in the form of a query string. The result should look something like this:
Referer: https://arbitrary-incorrect-domain.net?YOUR-LAB-ID.web-security-academy.net
    
Send the request and observe that it is now accepted. The website seems to accept any Referer header as long as it contains 
the expected domain somewhere in the string.

Create a CSRF proof of concept exploit as described in the solution to the CSRF vulnerability with no defenses lab and host it on the exploit server. 
Edit the JavaScript so that the third argument of the history.pushState() function includes a query string with your lab instance URL as follows:
history.pushState("", "", "/?YOUR-LAB-ID.web-security-academy.net")

This will cause the Referer header in the generated request to contain the URL of the target site in the query string, just like we tested earlier.

If you store the exploit and test it by clicking "View exploit", you may encounter the "invalid Referer header" error again. 
This is because many browsers now strip the query string from the Referer header by default as a security measure. To override this behavior 
and ensure that the full URL is included in the request, go back to the exploit server and add the following header to the "Head" section:
Referrer-Policy: unsafe-url

Note that unlike the normal Referer header, the word "referrer" must be spelled correctly in this case.

Store the exploit, then click "Deliver to victim" to solve the lab.



